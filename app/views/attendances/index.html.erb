<div class="content-header">
  <div class="row">
    <div class="large-6 columns">
      <h2><%= t(:attendance_list)%></h2>
    </div>
    <div class="large-6 columns">
      <%= form_tag organization_attendances_path, 
        multipart: true, id: "new_attendance", method: :post do%>
        <%= file_field_tag :attendance_file %>
      <% end %>
    </div>
  </div>
  
  <div class="row">
    <div class="large-12 columns">
      <%= simple_form_for :date, wrapper: :custom, url: organization_attendances_path(current_organization), method: :get do |f| %>
        <%= f.input :year, collection: (@year-3..@year+3), include_blank: false, selected: @year %>
        <%= f.input :month, collection: @month_collection, include_blank: false, selected: @month %>
          
        <div class="row">
          <div class="large-3 small-3 columns"></div>
          <div class="large-9 small-9 columns">
            <%= f.submit t(:change_date), class: "button success"%>
          </div>
        </div>
      <% end %> 
    </div>
  </div>
  
  <div class="row">
    <div class="large-12 columns">
      

      <div class="table-overflow">
        <table class="large-12">
          <thead>
            <th><%= t :employee_name %></th>
            <% (1..@date.end_of_month.day).each do |d|%>
              <th><%= d%></th>
            <% end %>
          </thead>
          
          <tbody>
            <% @employees.each do |employee|%>
              <tr>
                <td><%= employee.name_with_initial%></td>
                <% count = 1 %>
                <% while count <= @date.end_of_month.day%>
                  <td>
                    <% zone = current_organization.time_zone%>
                    <% attendances = employee.attendances.where(clock_time: @date+(count-1).day..@date+count.day) %>
                    <% data_reveal_str = employee.last_name + employee.id.to_s + "_" + count.to_s%>
                    <%= link_to calculate_hours(attendances), "#", :"data-reveal-id" => data_reveal_str%>
                    <div id="<%= data_reveal_str %>" class="reveal-modal" data-reveal>
                      <h2>Attendance for <%= employee.full_name %> on <%= (@date+count).to_date %></h2>
                      <ul>
                        <% attendances.each do |attendance| %>
                          <li><%= attendance.clock_time %></li>
                        <% end %>
                      </ul>
                      <a class="close-reveal-modal">&#215;</a>
                    </div>
                  </td>
                  <% count = count + 1 %>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>   
    </div>
  </div>
  
</div>

<script>
  $("#new_attendance").change(function(){
    $("#new_attendance").submit();
  });
</script>


